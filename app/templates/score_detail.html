{% extends "base.html" %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb">
  <div class="container">
    <a href="/" class="breadcrumb-item">
      <i class="fas fa-home"></i>
      Home
    </a>
    <i class="fas fa-chevron-right breadcrumb-separator"></i>
    <span class="breadcrumb-item active">Score Details</span>
  </div>
</nav>

<!-- Score Header -->
<section class="score-hero">
  <div class="container">
    <div class="score-hero-content">
      <!-- Left: Wallet Info -->
      <div class="wallet-info">
        <div class="wallet-header">
          <div class="wallet-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="wallet-details">
            <span class="wallet-label">Ethereum Address</span>
            <div class="wallet-address-row">
              <code class="wallet-address" id="walletAddress">{{ wallet_address }}</code>
              <button class="copy-btn" data-copy="{{ wallet_address }}" title="Copy address">
                <i class="fas fa-copy"></i>
              </button>
              <a href="https://etherscan.io/address/{{ wallet_address }}" target="_blank" class="etherscan-link" title="View on Etherscan">
                <i class="fas fa-external-link-alt"></i>
              </a>
            </div>
          </div>
        </div>
        
        {% if message %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <span>{{ message }}</span>
        </div>
        {% endif %}
      </div>

      <!-- Right: Score Display -->
      <div class="score-display">
        <div class="score-ring" data-score="{{ score }}">
          <svg viewBox="0 0 200 200">
            <circle class="score-ring-bg" cx="100" cy="100" r="90" />
            <circle class="score-ring-progress" cx="100" cy="100" r="90" />
          </svg>
          <div class="score-value-wrapper">
            <span class="score-value">{{ "%.0f"|format(score) }}</span>
            <span class="score-max">/ 1000</span>
          </div>
        </div>
        <div class="score-rating">
          {% if score >= 800 %}
          <span class="rating-badge rating-excellent">
            <i class="fas fa-star"></i> Excellent
          </span>
          {% elif score >= 650 %}
          <span class="rating-badge rating-good">
            <i class="fas fa-thumbs-up"></i> Good
          </span>
          {% elif score >= 500 %}
          <span class="rating-badge rating-fair">
            <i class="fas fa-minus-circle"></i> Fair
          </span>
          {% else %}
          <span class="rating-badge rating-poor">
            <i class="fas fa-exclamation-triangle"></i> Needs Improvement
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Quick Stats -->
<section class="quick-stats">
  <div class="container">
    <div class="quick-stats-grid">
      <div class="quick-stat-card">
        <div class="quick-stat-icon">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="quick-stat-info">
          <span class="quick-stat-value">{{ features.total_transactions or 0 }}</span>
          <span class="quick-stat-label">Total Transactions</span>
        </div>
      </div>

      <div class="quick-stat-card">
        <div class="quick-stat-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="quick-stat-info">
          <span class="quick-stat-value">{{ features.account_age_days or 0 }}</span>
          <span class="quick-stat-label">Account Age (Days)</span>
        </div>
      </div>

      <div class="quick-stat-card">
        <div class="quick-stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="quick-stat-info">
          <span class="quick-stat-value">{{ features.unique_counterparties or 0 }}</span>
          <span class="quick-stat-label">Unique Counterparties</span>
        </div>
      </div>

      <div class="quick-stat-card">
        <div class="quick-stat-icon">
          <i class="fab fa-ethereum"></i>
        </div>
        <div class="quick-stat-info">
          <span class="quick-stat-value">{{ "%.4f"|format(features.net_eth_change or 0) }}</span>
          <span class="quick-stat-label">Net ETH Change</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Action Bar -->
{% if report_enabled %}
<section class="action-bar">
  <div class="container">
    <div class="action-bar-content">
      <div class="action-bar-info">
        <i class="fas fa-file-alt"></i>
        <span>Generate an AI-powered detailed credit report for this wallet</span>
      </div>
      <a href="/api/v1/wallets/{{ wallet_address }}/report" class="btn btn-primary">
        <i class="fas fa-chart-line"></i>
        View Full Report
      </a>
    </div>
  </div>
</section>
{% endif %}

<!-- Main Content Grid -->
<section class="details-section">
  <div class="container">
    <div class="details-grid">
      <!-- Features Table -->
      <div class="details-card features-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-list-ul"></i>
            On-Chain Features
          </h3>
          <span class="card-badge">{{ features|length }} Metrics</span>
        </div>
        <div class="card-body">
          <div class="features-table-wrapper">
            <table class="features-table">
              <thead>
                <tr>
                  <th>Feature</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                {% for key, value in features.items() %}
                <tr>
                  <td>
                    <span class="feature-name">{{ key.replace("_", " ")|title }}</span>
                    <code class="feature-key">{{ key }}</code>
                  </td>
                  <td>
                    <span class="feature-value">
                      {% if value is number %}
                        {% if value == value|int %}
                          {{ value|int }}
                        {% else %}
                          {{ "%.4f"|format(value) }}
                        {% endif %}
                      {% else %}
                        {{ value }}
                      {% endif %}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Off-Chain Persona -->
      <div class="details-card persona-card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-user-circle"></i>
            Off-Chain Persona
          </h3>
        </div>
        <div class="card-body">
          {% if offchain %}
          <div class="persona-grid">
            {% for key, value in offchain.items() %}
            <div class="persona-item">
              <div class="persona-icon">
                {% if 'age' in key.lower() %}
                <i class="fas fa-birthday-cake"></i>
                {% elif 'income' in key.lower() or 'salary' in key.lower() %}
                <i class="fas fa-money-bill-wave"></i>
                {% elif 'job' in key.lower() or 'occupation' in key.lower() or 'employment' in key.lower() %}
                <i class="fas fa-briefcase"></i>
                {% elif 'education' in key.lower() %}
                <i class="fas fa-graduation-cap"></i>
                {% elif 'location' in key.lower() or 'country' in key.lower() or 'city' in key.lower() %}
                <i class="fas fa-map-marker-alt"></i>
                {% elif 'risk' in key.lower() %}
                <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                <i class="fas fa-tag"></i>
                {% endif %}
              </div>
              <div class="persona-details">
                <span class="persona-label">{{ key.replace("_", " ")|title }}</span>
                <span class="persona-value">{{ value }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <i class="fas fa-user-slash"></i>
            <p>No off-chain persona data available</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Score Analysis -->
<section class="analysis-section">
  <div class="container">
    <div class="analysis-card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-line"></i>
          Score Analysis
        </h3>
      </div>
      <div class="card-body">
        <div class="score-breakdown">
          <div class="breakdown-item">
            <div class="breakdown-header">
              <span class="breakdown-label">Transaction Activity</span>
              <span class="breakdown-value">{{ features.total_transactions or 0 }} txns</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ [100, (features.total_transactions or 0) / 10]|min }}%;"></div>
            </div>
          </div>

          <div class="breakdown-item">
            <div class="breakdown-header">
              <span class="breakdown-label">Account Maturity</span>
              <span class="breakdown-value">{{ features.account_age_days or 0 }} days</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ [100, (features.account_age_days or 0) / 3.65]|min }}%;"></div>
            </div>
          </div>

          <div class="breakdown-item">
            <div class="breakdown-header">
              <span class="breakdown-label">Network Diversity</span>
              <span class="breakdown-value">{{ features.unique_counterparties or 0 }} addresses</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ [100, (features.unique_counterparties or 0) * 2]|min }}%;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Charts Section -->
{% if time_series and time_series.monthly %}
<section class="charts-section">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-chart-area"></i>
        Activity Analytics
      </h2>
      <p class="section-subtitle">Historical transaction patterns and trends</p>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Monthly Transaction Count Chart -->
      <div class="chart-card chart-large">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-chart-bar"></i>
            Monthly Transaction Activity
          </h3>
          <div class="chart-legend">
            <span class="legend-item legend-sent"><span class="legend-dot"></span> Sent</span>
            <span class="legend-item legend-received"><span class="legend-dot"></span> Received</span>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="monthlyTxChart"></canvas>
        </div>
      </div>

      <!-- Monthly ETH Volume Chart -->
      <div class="chart-card chart-large">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fab fa-ethereum"></i>
            Monthly ETH Flow
          </h3>
          <div class="chart-legend">
            <span class="legend-item legend-in"><span class="legend-dot"></span> Inflow</span>
            <span class="legend-item legend-out"><span class="legend-dot"></span> Outflow</span>
            <span class="legend-item legend-net"><span class="legend-dot"></span> Net</span>
          </div>
        </div>
        <div class="chart-body">
          <canvas id="monthlyEthChart"></canvas>
        </div>
      </div>

      <!-- Cumulative Growth Chart -->
      <div class="chart-card chart-large">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-chart-line"></i>
            Cumulative Transaction Growth
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="cumulativeChart"></canvas>
        </div>
      </div>

      <!-- Weekly Activity Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-calendar-week"></i>
            Weekly Activity (Last 12 Weeks)
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <!-- Weekday Distribution Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-calendar-day"></i>
            Activity by Weekday
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="weekdayChart"></canvas>
        </div>
      </div>

      <!-- Hourly Distribution Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-clock"></i>
            Activity by Hour (UTC)
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>

      <!-- Transaction Value Distribution -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-coins"></i>
            Transaction Value Distribution
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="valueDistChart"></canvas>
        </div>
      </div>

      <!-- Monthly Counterparties -->
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">
            <i class="fas fa-users"></i>
            Monthly Unique Counterparties
          </h3>
        </div>
        <div class="chart-body">
          <canvas id="counterpartiesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Navigation -->
<section class="back-nav">
  <div class="container">
    <a href="/" class="back-link">
      <i class="fas fa-arrow-left"></i>
      <span>Analyze Another Wallet</span>
    </a>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Time series data from backend
  const timeSeriesData = {{ time_series | tojson | safe }};
  
  // Chart.js default configuration
  const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
  
  Chart.defaults.color = isDarkMode ? '#a0aec0' : '#64748b';
  Chart.defaults.borderColor = isDarkMode ? '#2d3748' : '#e2e8f0';
  Chart.defaults.font.family = "'Inter', sans-serif";
  
  // Color palette
  const colors = {
    primary: '#3b82f6',
    secondary: '#8b5cf6',
    success: '#10b981',
    danger: '#ef4444',
    warning: '#f59e0b',
    info: '#06b6d4',
    sent: '#ef4444',
    received: '#10b981',
    net: '#3b82f6'
  };

  // Animate score ring on load
  document.addEventListener('DOMContentLoaded', function() {
    const scoreRing = document.querySelector('.score-ring');
    if (scoreRing) {
      const score = parseFloat(scoreRing.dataset.score) || 0;
      const progress = (score / 1000) * 100;
      const circle = scoreRing.querySelector('.score-ring-progress');
      const circumference = 2 * Math.PI * 90;
      const offset = circumference - (progress / 100) * circumference;
      
      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = circumference;
      
      setTimeout(() => {
        circle.style.transition = 'stroke-dashoffset 1.5s ease-out';
        circle.style.strokeDashoffset = offset;
      }, 100);
    }

    // Initialize charts if data exists
    if (timeSeriesData && timeSeriesData.monthly && timeSeriesData.monthly.length > 0) {
      initializeCharts();
    }
  });

  function initializeCharts() {
    // Monthly Transaction Chart
    const monthlyTxCtx = document.getElementById('monthlyTxChart');
    if (monthlyTxCtx && timeSeriesData.monthly) {
      const last12Months = timeSeriesData.monthly.slice(-12);
      new Chart(monthlyTxCtx, {
        type: 'bar',
        data: {
          labels: last12Months.map(d => d.month),
          datasets: [
            {
              label: 'Sent',
              data: last12Months.map(d => d.tx_sent),
              backgroundColor: colors.sent + '80',
              borderColor: colors.sent,
              borderWidth: 1
            },
            {
              label: 'Received',
              data: last12Months.map(d => d.tx_received),
              backgroundColor: colors.received + '80',
              borderColor: colors.received,
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              stacked: true,
              grid: { display: false }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              title: { display: true, text: 'Transactions' }
            }
          }
        }
      });
    }

    // Monthly ETH Flow Chart
    const monthlyEthCtx = document.getElementById('monthlyEthChart');
    if (monthlyEthCtx && timeSeriesData.monthly) {
      const last12Months = timeSeriesData.monthly.slice(-12);
      new Chart(monthlyEthCtx, {
        type: 'line',
        data: {
          labels: last12Months.map(d => d.month),
          datasets: [
            {
              label: 'ETH Received',
              data: last12Months.map(d => d.eth_received),
              borderColor: colors.received,
              backgroundColor: colors.received + '20',
              fill: true,
              tension: 0.4
            },
            {
              label: 'ETH Sent',
              data: last12Months.map(d => d.eth_sent),
              borderColor: colors.sent,
              backgroundColor: colors.sent + '20',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Net ETH',
              data: last12Months.map(d => d.net_eth),
              borderColor: colors.net,
              backgroundColor: 'transparent',
              borderWidth: 2,
              borderDash: [5, 5],
              tension: 0.4,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ETH' }
            }
          }
        }
      });
    }

    // Cumulative Growth Chart
    const cumulativeCtx = document.getElementById('cumulativeChart');
    if (cumulativeCtx && timeSeriesData.cumulative) {
      new Chart(cumulativeCtx, {
        type: 'line',
        data: {
          labels: timeSeriesData.cumulative.map(d => d.month),
          datasets: [
            {
              label: 'Total Transactions',
              data: timeSeriesData.cumulative.map(d => d.cumulative_tx),
              borderColor: colors.primary,
              backgroundColor: colors.primary + '20',
              fill: true,
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Cumulative Net ETH',
              data: timeSeriesData.cumulative.map(d => d.cumulative_net),
              borderColor: colors.success,
              backgroundColor: 'transparent',
              borderWidth: 2,
              tension: 0.4,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { display: true, position: 'top' }
          },
          scales: {
            x: { grid: { display: false } },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Transactions' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Net ETH' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    // Weekly Activity Chart
    const weeklyCtx = document.getElementById('weeklyChart');
    if (weeklyCtx && timeSeriesData.weekly) {
      const last12Weeks = timeSeriesData.weekly.slice(-12);
      new Chart(weeklyCtx, {
        type: 'bar',
        data: {
          labels: last12Weeks.map(d => d.week),
          datasets: [{
            label: 'Transactions',
            data: last12Weeks.map(d => d.tx_count),
            backgroundColor: colors.primary + '80',
            borderColor: colors.primary,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Weekday Distribution Chart
    const weekdayCtx = document.getElementById('weekdayChart');
    if (weekdayCtx && timeSeriesData.weekday_distribution) {
      const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const weekdayData = new Array(7).fill(0);
      timeSeriesData.weekday_distribution.forEach(d => {
        weekdayData[d.day_num] = d.count;
      });
      
      new Chart(weekdayCtx, {
        type: 'bar',
        data: {
          labels: weekdays,
          datasets: [{
            label: 'Transactions',
            data: weekdayData,
            backgroundColor: weekdayData.map((_, i) => 
              i >= 5 ? colors.warning + '80' : colors.info + '80'
            ),
            borderColor: weekdayData.map((_, i) => 
              i >= 5 ? colors.warning : colors.info
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Hourly Distribution Chart
    const hourlyCtx = document.getElementById('hourlyChart');
    if (hourlyCtx && timeSeriesData.hourly_distribution) {
      const hourlyData = new Array(24).fill(0);
      timeSeriesData.hourly_distribution.forEach(d => {
        hourlyData[d.hour] = d.count;
      });
      
      new Chart(hourlyCtx, {
        type: 'line',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Transactions',
            data: hourlyData,
            borderColor: colors.secondary,
            backgroundColor: colors.secondary + '20',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Value Distribution Chart
    const valueDistCtx = document.getElementById('valueDistChart');
    if (valueDistCtx && timeSeriesData.value_distribution) {
      new Chart(valueDistCtx, {
        type: 'doughnut',
        data: {
          labels: timeSeriesData.value_distribution.map(d => d.bucket + ' ETH'),
          datasets: [{
            data: timeSeriesData.value_distribution.map(d => d.count),
            backgroundColor: [
              colors.success + '80',
              colors.info + '80',
              colors.primary + '80',
              colors.secondary + '80',
              colors.warning + '80',
              colors.danger + '80',
              '#6b7280' + '80'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'right',
              labels: { boxWidth: 12, padding: 8 }
            }
          }
        }
      });
    }

    // Monthly Counterparties Chart
    const counterpartiesCtx = document.getElementById('counterpartiesChart');
    if (counterpartiesCtx && timeSeriesData.monthly) {
      const last12Months = timeSeriesData.monthly.slice(-12);
      new Chart(counterpartiesCtx, {
        type: 'line',
        data: {
          labels: last12Months.map(d => d.month),
          datasets: [{
            label: 'Unique Counterparties',
            data: last12Months.map(d => d.unique_counterparties),
            borderColor: colors.info,
            backgroundColor: colors.info + '20',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }
  }

  // Theme change handling - update chart colors without page reload
  // Store initial theme to detect actual user-triggered changes
  let initialTheme = document.documentElement.getAttribute('data-theme');
  let themeInitialized = false;
  
  // Only listen for theme changes after initial page load is complete
  setTimeout(() => {
    themeInitialized = true;
  }, 1000);
  
  const observer = new MutationObserver((mutations) => {
    if (!themeInitialized) return; // Skip during initial page load
    
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        const newTheme = document.documentElement.getAttribute('data-theme');
        // Only act if theme actually changed (user clicked toggle)
        if (newTheme !== initialTheme) {
          initialTheme = newTheme;
          // Update chart colors dynamically instead of reloading
          updateChartTheme(newTheme === 'dark');
        }
      }
    });
  });
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
  
  // Update chart colors without page reload
  function updateChartTheme(isDark) {
    const textColor = isDark ? '#a0aec0' : '#64748b';
    const borderColor = isDark ? '#2d3748' : '#e2e8f0';
    
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = borderColor;
    
    // Update all existing charts
    Object.values(Chart.instances).forEach(chart => {
      chart.options.scales.x.ticks.color = textColor;
      chart.options.scales.y.ticks.color = textColor;
      chart.update('none');
    });
  }
</script>
{% endblock %}

