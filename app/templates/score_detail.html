{% extends "base.html" %}

{% block content %}
<!-- Compact Header Bar -->
<div class="score-page-header">
  <div class="container">
    <div class="header-row">
      <!-- Left: Breadcrumb & Wallet -->
      <div class="header-left">
        <nav class="breadcrumb-inline">
          <a href="/"><i class="fas fa-home"></i></a>
          <i class="fas fa-chevron-right"></i>
          <span>Score Analysis</span>
        </nav>
        <div class="wallet-compact">
          <i class="fas fa-wallet"></i>
          <code class="wallet-addr">{{ wallet_address }}</code>
          <button class="icon-btn" data-copy="{{ wallet_address }}" title="Copy">
            <i class="fas fa-copy"></i>
          </button>
          <a href="https://etherscan.io/address/{{ wallet_address }}" target="_blank" class="icon-btn" title="Etherscan">
            <i class="fas fa-external-link-alt"></i>
          </a>
        </div>
      </div>
      
      <!-- Right: Actions -->
      <div class="header-right">
        {% if report_enabled %}
        <a href="/api/v1/wallets/{{ wallet_address }}/report" class="btn btn-primary btn-sm">
          <i class="fas fa-file-alt"></i>
          <span>Full Report</span>
        </a>
        {% endif %}
        <a href="/" class="btn btn-outline btn-sm">
          <i class="fas fa-search"></i>
          <span>New Search</span>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Main Dashboard Grid -->
<main class="dashboard-main">
  <div class="container">
    <div class="dashboard-grid">
      
      <!-- LEFT COLUMN: Score & Key Metrics -->
      <aside class="dashboard-sidebar">
        <!-- Score Card -->
        <div class="score-card-main">
          <div class="score-ring-container" data-score="{{ score }}">
            <svg class="score-ring-svg" viewBox="0 0 120 120">
              <circle class="score-ring-bg" cx="60" cy="60" r="52" />
              <circle class="score-ring-progress" cx="60" cy="60" r="52" />
            </svg>
            <div class="score-center">
              <span class="score-number">{{ "%.0f"|format(score) }}</span>
              <span class="score-label">/ 1000</span>
            </div>
          </div>
          <div class="score-rating-badge">
            {% if score >= 700 %}
            <span class="badge badge-excellent"><i class="fas fa-shield-alt"></i> Grade 1 - Ultra Low Risk</span>
            {% elif score >= 653 %}
            <span class="badge badge-good"><i class="fas fa-check-circle"></i> Grade 2 - Very Low Risk</span>
            {% elif score >= 600 %}
            <span class="badge badge-fair"><i class="fas fa-thumbs-up"></i> Grade 3 - Low Risk</span>
            {% elif score >= 570 %}
            <span class="badge badge-moderate"><i class="fas fa-exclamation-circle"></i> Grade 4 - Moderate Risk</span>
            {% elif score >= 528 %}
            <span class="badge badge-poor"><i class="fas fa-exclamation-triangle"></i> Grade 5 - High Risk</span>
            {% else %}
            <span class="badge badge-critical"><i class="fas fa-times-circle"></i> Grade 6 - Very High Risk</span>
            {% endif %}
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-card">
          <h3 class="card-title-sm"><i class="fas fa-tachometer-alt"></i> Key Metrics</h3>
          <div class="metric-list">
            <div class="metric-row">
              <span class="metric-label"><i class="fas fa-exchange-alt"></i> Total Transactions</span>
              <span class="metric-value">{{ features.total_transactions or 0 }}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label"><i class="fas fa-calendar"></i> Account Age</span>
              <span class="metric-value">{{ features.account_age_days or 0 }} days</span>
            </div>
            <div class="metric-row">
              <span class="metric-label"><i class="fas fa-users"></i> Counterparties</span>
              <span class="metric-value">{{ features.unique_counterparties or 0 }}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label"><i class="fab fa-ethereum"></i> Net ETH</span>
              <span class="metric-value {% if (features.net_eth_change or 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                {{ "%.4f"|format(features.net_eth_change or 0) }}
              </span>
            </div>
            <div class="metric-row">
              <span class="metric-label"><i class="fas fa-file-contract"></i> Contract Interactions</span>
              <span class="metric-value">{{ features.contract_interactions or 0 }}</span>
            </div>
            <div class="metric-row">
              <span class="metric-label"><i class="fas fa-clock"></i> Days Since Last Tx</span>
              <span class="metric-value">{{ features.days_since_last_tx or 0 }}</span>
            </div>
          </div>
        </div>

        <!-- Score Factors -->
        <div class="factors-card">
          <h3 class="card-title-sm"><i class="fas fa-balance-scale"></i> Score Factors</h3>
          <div class="factor-bars">
            <div class="factor-item">
              <div class="factor-header">
                <span>Activity</span>
                <span>{{ [100, (features.total_transactions or 0) / 10]|min|int }}%</span>
              </div>
              <div class="factor-bar">
                <div class="factor-fill" style="width: {{ [100, (features.total_transactions or 0) / 10]|min }}%"></div>
              </div>
            </div>
            <div class="factor-item">
              <div class="factor-header">
                <span>Maturity</span>
                <span>{{ [100, (features.account_age_days or 0) / 3.65]|min|int }}%</span>
              </div>
              <div class="factor-bar">
                <div class="factor-fill" style="width: {{ [100, (features.account_age_days or 0) / 3.65]|min }}%"></div>
              </div>
            </div>
            <div class="factor-item">
              <div class="factor-header">
                <span>Network</span>
                <span>{{ [100, (features.unique_counterparties or 0) * 2]|min|int }}%</span>
              </div>
              <div class="factor-bar">
                <div class="factor-fill" style="width: {{ [100, (features.unique_counterparties or 0) * 2]|min }}%"></div>
              </div>
            </div>
            <div class="factor-item">
              <div class="factor-header">
                <span>Reliability</span>
                <span>{{ [100, 100 - (features.failed_tx_ratio or 0) * 100]|min|int }}%</span>
              </div>
              <div class="factor-bar">
                <div class="factor-fill factor-fill-success" style="width: {{ [100, 100 - (features.failed_tx_ratio or 0) * 100]|min }}%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Off-Chain Persona (if available) -->
        {% if offchain %}
        <div class="persona-card-compact">
          <h3 class="card-title-sm"><i class="fas fa-user-circle"></i> Persona</h3>
          <div class="persona-items">
            {% for key, value in offchain.items() %}
            <div class="persona-row">
              <span class="persona-key">{{ key.replace("_", " ")|title }}</span>
              <span class="persona-val">{{ value }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </aside>

      <!-- RIGHT COLUMN: Charts & Details -->
      <section class="dashboard-content">
        {% if time_series and time_series.monthly %}
        <!-- Primary Charts Row -->
        <div class="charts-row-primary">
          <div class="chart-panel chart-wide">
            <div class="chart-panel-header">
              <h3><i class="fas fa-chart-bar"></i> Transaction Activity</h3>
              <div class="chart-legend-inline">
                <span class="legend-dot-sent"></span> Sent
                <span class="legend-dot-recv"></span> Received
              </div>
            </div>
            <div class="chart-panel-body">
              <canvas id="monthlyTxChart"></canvas>
            </div>
          </div>
          
          <div class="chart-panel chart-wide">
            <div class="chart-panel-header">
              <h3><i class="fab fa-ethereum"></i> ETH Flow</h3>
              <div class="chart-legend-inline">
                <span class="legend-dot-in"></span> In
                <span class="legend-dot-out"></span> Out
                <span class="legend-dot-net"></span> Net
              </div>
            </div>
            <div class="chart-panel-body">
              <canvas id="monthlyEthChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Secondary Charts Row -->
        <div class="charts-row-secondary">
          <div class="chart-panel">
            <div class="chart-panel-header">
              <h3><i class="fas fa-chart-line"></i> Cumulative Growth</h3>
            </div>
            <div class="chart-panel-body chart-body-md">
              <canvas id="cumulativeChart"></canvas>
            </div>
          </div>

          <div class="chart-panel">
            <div class="chart-panel-header">
              <h3><i class="fas fa-users"></i> Counterparties</h3>
            </div>
            <div class="chart-panel-body chart-body-md">
              <canvas id="counterpartiesChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tertiary Charts Row -->
        <div class="charts-row-tertiary">
          <div class="chart-panel chart-sm">
            <div class="chart-panel-header">
              <h3><i class="fas fa-calendar-day"></i> By Weekday</h3>
            </div>
            <div class="chart-panel-body chart-body-sm">
              <canvas id="weekdayChart"></canvas>
            </div>
          </div>

          <div class="chart-panel chart-sm">
            <div class="chart-panel-header">
              <h3><i class="fas fa-clock"></i> By Hour (UTC)</h3>
            </div>
            <div class="chart-panel-body chart-body-sm">
              <canvas id="hourlyChart"></canvas>
            </div>
          </div>

          <div class="chart-panel chart-sm">
            <div class="chart-panel-header">
              <h3><i class="fas fa-coins"></i> Value Distribution</h3>
            </div>
            <div class="chart-panel-body chart-body-sm">
              <canvas id="valueDistChart"></canvas>
            </div>
          </div>

          <div class="chart-panel chart-sm">
            <div class="chart-panel-header">
              <h3><i class="fas fa-calendar-week"></i> Weekly (12w)</h3>
            </div>
            <div class="chart-panel-body chart-body-sm">
              <canvas id="weeklyChart"></canvas>
            </div>
          </div>
        </div>
        {% else %}
        <!-- No chart data message -->
        <div class="no-data-panel">
          <i class="fas fa-chart-area"></i>
          <h3>Insufficient Data for Charts</h3>
          <p>This wallet doesn't have enough transaction history to display analytics charts.</p>
        </div>
        {% endif %}

        <!-- Detailed Features Table (Collapsible) -->
        <details class="features-details" open>
          <summary class="features-summary">
            <i class="fas fa-database"></i>
            <span>All On-Chain Features</span>
            <span class="features-count">{{ features|length }} metrics</span>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </summary>
          <div class="features-table-container">
            <table class="features-table-compact">
              <thead>
                <tr>
                  <th>Feature</th>
                  <th>Value</th>
                  <th>Feature</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                {% set feature_items = features.items()|list %}
                {% for i in range(0, feature_items|length, 2) %}
                <tr>
                  <td class="feature-name-cell">{{ feature_items[i][0].replace("_", " ")|title }}</td>
                  <td class="feature-value-cell">
                    {% if feature_items[i][1] is number %}
                      {% if feature_items[i][1] == feature_items[i][1]|int %}
                        {{ feature_items[i][1]|int }}
                      {% else %}
                        {{ "%.4f"|format(feature_items[i][1]) }}
                      {% endif %}
                    {% else %}
                      {{ feature_items[i][1] }}
                    {% endif %}
                  </td>
                  {% if i + 1 < feature_items|length %}
                  <td class="feature-name-cell">{{ feature_items[i+1][0].replace("_", " ")|title }}</td>
                  <td class="feature-value-cell">
                    {% if feature_items[i+1][1] is number %}
                      {% if feature_items[i+1][1] == feature_items[i+1][1]|int %}
                        {{ feature_items[i+1][1]|int }}
                      {% else %}
                        {{ "%.4f"|format(feature_items[i+1][1]) }}
                      {% endif %}
                    {% else %}
                      {{ feature_items[i+1][1] }}
                    {% endif %}
                  </td>
                  {% else %}
                  <td></td>
                  <td></td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      </section>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Time series data from backend
  const timeSeriesData = {{ time_series | tojson | safe }};
  
  // Chart.js configuration
  const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
  
  Chart.defaults.color = isDarkMode ? '#94a3b8' : '#64748b';
  Chart.defaults.borderColor = isDarkMode ? '#334155' : '#e2e8f0';
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.font.size = 11;
  
  // Color palette
  const colors = {
    primary: '#3b82f6',
    secondary: '#8b5cf6',
    success: '#10b981',
    danger: '#ef4444',
    warning: '#f59e0b',
    info: '#06b6d4',
    sent: '#ef4444',
    received: '#10b981',
    net: '#3b82f6'
  };

  // Compact chart options
  const compactOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: { 
        backgroundColor: isDarkMode ? '#1e293b' : '#fff',
        titleColor: isDarkMode ? '#f1f5f9' : '#1e293b',
        bodyColor: isDarkMode ? '#94a3b8' : '#64748b',
        borderColor: isDarkMode ? '#334155' : '#e2e8f0',
        borderWidth: 1,
        padding: 8,
        cornerRadius: 6
      }
    },
    scales: {
      x: { 
        grid: { display: false },
        ticks: { maxRotation: 45, font: { size: 10 } }
      },
      y: { 
        beginAtZero: true,
        grid: { color: isDarkMode ? '#1e293b' : '#f1f5f9' },
        ticks: { font: { size: 10 } }
      }
    }
  };

  document.addEventListener('DOMContentLoaded', function() {
    // Animate score ring
    const scoreContainer = document.querySelector('.score-ring-container');
    if (scoreContainer) {
      const score = parseFloat(scoreContainer.dataset.score) || 0;
      const progress = (score / 1000) * 100;
      const circle = scoreContainer.querySelector('.score-ring-progress');
      const circumference = 2 * Math.PI * 52;
      const offset = circumference - (progress / 100) * circumference;
      
      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = circumference;
      
      setTimeout(() => {
        circle.style.transition = 'stroke-dashoffset 1.2s ease-out';
        circle.style.strokeDashoffset = offset;
      }, 100);
    }

    // Initialize charts
    if (timeSeriesData && timeSeriesData.monthly && timeSeriesData.monthly.length > 0) {
      initCharts();
    }
    
    // Copy functionality
    document.querySelectorAll('[data-copy]').forEach(btn => {
      btn.addEventListener('click', function() {
        navigator.clipboard.writeText(this.dataset.copy);
        const icon = this.querySelector('i');
        icon.className = 'fas fa-check';
        setTimeout(() => icon.className = 'fas fa-copy', 1500);
      });
    });
  });

  function initCharts() {
    const last12 = timeSeriesData.monthly.slice(-12);
    
    // Monthly Transactions
    const txCtx = document.getElementById('monthlyTxChart');
    if (txCtx) {
      new Chart(txCtx, {
        type: 'bar',
        data: {
          labels: last12.map(d => d.month.slice(-7)),
          datasets: [
            { label: 'Sent', data: last12.map(d => d.tx_sent), backgroundColor: colors.sent + '90', borderRadius: 3 },
            { label: 'Received', data: last12.map(d => d.tx_received), backgroundColor: colors.received + '90', borderRadius: 3 }
          ]
        },
        options: { ...compactOptions, scales: { ...compactOptions.scales, x: { ...compactOptions.scales.x, stacked: true }, y: { ...compactOptions.scales.y, stacked: true } } }
      });
    }

    // ETH Flow
    const ethCtx = document.getElementById('monthlyEthChart');
    if (ethCtx) {
      new Chart(ethCtx, {
        type: 'line',
        data: {
          labels: last12.map(d => d.month.slice(-7)),
          datasets: [
            { label: 'In', data: last12.map(d => d.eth_received), borderColor: colors.received, backgroundColor: colors.received + '20', fill: true, tension: 0.3 },
            { label: 'Out', data: last12.map(d => d.eth_sent), borderColor: colors.sent, backgroundColor: colors.sent + '20', fill: true, tension: 0.3 },
            { label: 'Net', data: last12.map(d => d.net_eth), borderColor: colors.net, borderDash: [4,4], fill: false, tension: 0.3 }
          ]
        },
        options: compactOptions
      });
    }

    // Cumulative
    const cumCtx = document.getElementById('cumulativeChart');
    if (cumCtx && timeSeriesData.cumulative) {
      new Chart(cumCtx, {
        type: 'line',
        data: {
          labels: timeSeriesData.cumulative.map(d => d.month.slice(-7)),
          datasets: [{
            label: 'Cumulative Tx',
            data: timeSeriesData.cumulative.map(d => d.cumulative_tx),
            borderColor: colors.primary,
            backgroundColor: colors.primary + '20',
            fill: true,
            tension: 0.3
          }]
        },
        options: compactOptions
      });
    }

    // Counterparties
    const cpCtx = document.getElementById('counterpartiesChart');
    if (cpCtx) {
      new Chart(cpCtx, {
        type: 'line',
        data: {
          labels: last12.map(d => d.month.slice(-7)),
          datasets: [{
            label: 'Counterparties',
            data: last12.map(d => d.unique_counterparties),
            borderColor: colors.info,
            backgroundColor: colors.info + '20',
            fill: true,
            tension: 0.3
          }]
        },
        options: compactOptions
      });
    }

    // Weekday
    const wdCtx = document.getElementById('weekdayChart');
    if (wdCtx && timeSeriesData.weekday_distribution) {
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const wdData = new Array(7).fill(0);
      timeSeriesData.weekday_distribution.forEach(d => wdData[d.day_num] = d.count);
      new Chart(wdCtx, {
        type: 'bar',
        data: {
          labels: days,
          datasets: [{ data: wdData, backgroundColor: wdData.map((_, i) => i >= 5 ? colors.warning + '80' : colors.info + '80'), borderRadius: 3 }]
        },
        options: compactOptions
      });
    }

    // Hourly
    const hrCtx = document.getElementById('hourlyChart');
    if (hrCtx && timeSeriesData.hourly_distribution) {
      const hrData = new Array(24).fill(0);
      timeSeriesData.hourly_distribution.forEach(d => hrData[d.hour] = d.count);
      new Chart(hrCtx, {
        type: 'line',
        data: {
          labels: Array.from({length: 24}, (_, i) => i),
          datasets: [{ data: hrData, borderColor: colors.secondary, backgroundColor: colors.secondary + '20', fill: true, tension: 0.4 }]
        },
        options: compactOptions
      });
    }

    // Value Distribution
    const vdCtx = document.getElementById('valueDistChart');
    if (vdCtx && timeSeriesData.value_distribution) {
      new Chart(vdCtx, {
        type: 'doughnut',
        data: {
          labels: timeSeriesData.value_distribution.map(d => d.bucket),
          datasets: [{
            data: timeSeriesData.value_distribution.map(d => d.count),
            backgroundColor: [colors.success+'90', colors.info+'90', colors.primary+'90', colors.secondary+'90', colors.warning+'90', colors.danger+'90', '#6b7280'+'90'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } }
        }
      });
    }

    // Weekly
    const wkCtx = document.getElementById('weeklyChart');
    if (wkCtx && timeSeriesData.weekly) {
      const last12w = timeSeriesData.weekly.slice(-12);
      new Chart(wkCtx, {
        type: 'bar',
        data: {
          labels: last12w.map((d, i) => `W${i+1}`),
          datasets: [{ data: last12w.map(d => d.tx_count), backgroundColor: colors.primary + '80', borderRadius: 2 }]
        },
        options: compactOptions
      });
    }
  }
</script>
{% endblock %}

